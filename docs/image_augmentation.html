
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Data augmentation &#8212; Deep Learning</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Classification I" href="structured_data_classification_intro.html" />
    <link rel="prev" title="Image preprocessing and data augmentation" href="image_classification_from_scratch.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Deep Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="deep-learning.html">
   Deep Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tensorflow.html">
   TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tf-example.html">
   TensorFlow Example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hugging-face.html">
   Hugging Face
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Keras intro
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="keras-sequential.html">
   Keras Sequential model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="keras-functional.html">
   Keras Functional API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="keras-preprocessing.html">
   Preprocessing Layers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="keras-tuner.html">
   KerasTuner
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Computer vision intro
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="fashion-mnist.html">
   Classify images of clothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fashion-mnist-exercises.html">
   Model exercises
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="convolutional.html">
   Convolutional
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cnn.html">
   TF CNN
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  CNN
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="mnist-cnn.html">
   CNN intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mnist-tensorflow.html">
   MNIST with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mnist-pytorch.html">
   MNIST with PyTorch
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Image augmentation
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="image_classification_from_scratch.html">
   Image preprocessing and data augmentation
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Data augmentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Structured data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="structured_data_classification_intro.html">
   Classification I
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="structured_data_classification_functions.html">
   Classification II
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="keras-imdb.html">
   IMDB Sentiment analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="keras-time.html">
   Time series regression
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="reference.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://colab.research.google.com/github/kirenz/deep-learning/blob/main/docs/image_augmentation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/kirenz/deep-learning"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/kirenz/deep-learning/issues/new?title=Issue%20on%20page%20%2Fdocs/image_augmentation.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/docs/image_augmentation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#download-a-dataset">
   Download a dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-keras-preprocessing-layers">
   Use Keras preprocessing layers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resizing-and-rescaling">
     Resizing and rescaling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data augmentation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-options-to-use-the-keras-preprocessing-layers">
     Two options to use the Keras preprocessing layers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-1-make-the-preprocessing-layers-part-of-your-model">
       Option 1: Make the preprocessing layers part of your model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-2-apply-the-preprocessing-layers-to-your-dataset">
       Option 2: Apply the preprocessing layers to your dataset
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#apply-the-preprocessing-layers-to-the-datasets">
     Apply the preprocessing layers to the datasets
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-a-model">
     Train a model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-data-augmentation">
     Custom data augmentation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-tf-image">
   Using tf.image
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Data augmentation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#flip-an-image">
       Flip an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#grayscale-an-image">
       Grayscale an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#saturate-an-image">
       Saturate an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#change-image-brightness">
       Change image brightness
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#center-crop-an-image">
       Center crop an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#rotate-an-image">
       Rotate an image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-transformations">
     Random transformations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-change-image-brightness">
       Randomly change image brightness
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-change-image-contrast">
       Randomly change image contrast
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-crop-an-image">
       Randomly crop an image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#apply-augmentation-to-a-dataset">
     Apply augmentation to a dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-1-using-tf-data-experimental-counter">
       Option 1: Using tf.data.experimental.Counter
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-2-using-tf-random-generator">
       Option 2: Using tf.random.Generator
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#next-steps">
   Next steps
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Data augmentation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#download-a-dataset">
   Download a dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-keras-preprocessing-layers">
   Use Keras preprocessing layers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resizing-and-rescaling">
     Resizing and rescaling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data augmentation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-options-to-use-the-keras-preprocessing-layers">
     Two options to use the Keras preprocessing layers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-1-make-the-preprocessing-layers-part-of-your-model">
       Option 1: Make the preprocessing layers part of your model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-2-apply-the-preprocessing-layers-to-your-dataset">
       Option 2: Apply the preprocessing layers to your dataset
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#apply-the-preprocessing-layers-to-the-datasets">
     Apply the preprocessing layers to the datasets
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-a-model">
     Train a model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-data-augmentation">
     Custom data augmentation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-tf-image">
   Using tf.image
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Data augmentation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#flip-an-image">
       Flip an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#grayscale-an-image">
       Grayscale an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#saturate-an-image">
       Saturate an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#change-image-brightness">
       Change image brightness
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#center-crop-an-image">
       Center crop an image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#rotate-an-image">
       Rotate an image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-transformations">
     Random transformations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-change-image-brightness">
       Randomly change image brightness
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-change-image-contrast">
       Randomly change image contrast
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#randomly-crop-an-image">
       Randomly crop an image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#apply-augmentation-to-a-dataset">
     Apply augmentation to a dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-1-using-tf-data-experimental-counter">
       Option 1: Using tf.data.experimental.Counter
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#option-2-using-tf-random-generator">
       Option 2: Using tf.random.Generator
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#next-steps">
   Next steps
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="data-augmentation">
<h1>Data augmentation<a class="headerlink" href="#data-augmentation" title="Permalink to this headline">#</a></h1>
<p>Copyright 2020 The TensorFlow Authors.</p>
<table class="tfo-notebook-buttons" align="left">
  <td>
    <a target="_blank" href="https://www.tensorflow.org/tutorials/images/data_augmentation"><img src="https://www.tensorflow.org/images/tf_logo_32px.png" />View on TensorFlow.org</a>
  </td>
  <td>
    <a target="_blank" href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/images/data_augmentation.ipynb"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" />Run in Google Colab</a>
  </td>
  <td>
    <a target="_blank" href="https://github.com/tensorflow/docs/blob/master/site/en/tutorials/images/data_augmentation.ipynb"><img src="https://www.tensorflow.org/images/GitHub-Mark-32px.png" />View source on GitHub</a>
  </td>
  <td>
    <a href="https://storage.googleapis.com/tensorflow_docs/docs/site/en/tutorials/images/data_augmentation.ipynb"><img src="https://www.tensorflow.org/images/download_logo_32px.png" />Download notebook</a>
  </td>
</table><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
</pre></div>
</div>
</div>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>This tutorial demonstrates data augmentation: a technique to increase the diversity of your training set by applying random (but realistic) transformations, such as image rotation.</p></li>
<li><p>You will learn how to apply data augmentation in two ways:</p></li>
<li><p>Use the Keras preprocessing layers, such as <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Resizing</span></code>, <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Rescaling</span></code>, <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomFlip</span></code>, and <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomRotation</span></code>.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">tf.image</span></code> methods, such as <code class="docutils literal notranslate"><span class="pre">tf.image.flip_left_right</span></code>, <code class="docutils literal notranslate"><span class="pre">tf.image.rgb_to_grayscale</span></code>, <code class="docutils literal notranslate"><span class="pre">tf.image.adjust_brightness</span></code>, <code class="docutils literal notranslate"><span class="pre">tf.image.central_crop</span></code>, and <code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random*</span></code>.</p></li>
</ul>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-a-dataset">
<h2>Download a dataset<a class="headerlink" href="#download-a-dataset" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>This tutorial uses the <a class="reference external" href="https://www.tensorflow.org/datasets/catalog/tf_flowers">tf_flowers</a> dataset.</p></li>
<li><p>For convenience, download the dataset using <a class="reference external" href="https://www.tensorflow.org/datasets">TensorFlow Datasets</a>.</p></li>
<li><p>If you would like to learn about other ways of importing data, check out the <a class="reference external" href="https://www.tensorflow.org/tutorials/load_data/images">load images</a> tutorial.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">),</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s1">&#39;tf_flowers&#39;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:80%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[80%:90%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span>
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-05-08 19:02:48.919413: W tensorflow/core/platform/cloud/google_auth_provider.cc:184] All attempts to get a Google authentication bearer token failed, returning an empty token. Retrieving token from files failed with &quot;NOT_FOUND: Could not locate the credentials file.&quot;. Retrieving token from GCE failed with &quot;FAILED_PRECONDITION: Error executing an HTTP request: libcurl code 6 meaning &#39;Couldn&#39;t resolve host name&#39;, error details: Could not resolve host: metadata&quot;.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Downloading and preparing dataset 218.21 MiB (download: 218.21 MiB, generated: 221.83 MiB, total: 440.05 MiB) to /Users/jankirenz/tensorflow_datasets/tf_flowers/3.0.1...</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dl Completed...: 100%|██████████| 5/5 [00:06&lt;00:00,  1.23s/ file]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Dataset tf_flowers downloaded and prepared to /Users/jankirenz/tensorflow_datasets/tf_flowers/3.0.1. Subsequent calls will reuse this data.</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-05-08 19:02:58.394694: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The flowers dataset has five classes.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<p>Let’s retrieve an image from the dataset and use it to demonstrate data augmentation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_label_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">int2str</span>

<span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">get_label_name</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-05-08 19:03:17.865343: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/image_augmentation_13_1.png" src="../_images/image_augmentation_13_1.png" />
</div>
</div>
</section>
<section id="use-keras-preprocessing-layers">
<h2>Use Keras preprocessing layers<a class="headerlink" href="#use-keras-preprocessing-layers" title="Permalink to this headline">#</a></h2>
<section id="resizing-and-rescaling">
<h3>Resizing and rescaling<a class="headerlink" href="#resizing-and-rescaling" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>You can use the Keras preprocessing layers to resize your images to a consistent shape (with <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Resizing</span></code>), and to rescale pixel values (with <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Rescaling</span></code>).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">180</span>

<span class="n">resize_and_rescale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Resizing</span><span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Rescaling</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Note: The rescaling layer above standardizes pixel values to the <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code> range.</p></li>
<li><p>If instead you wanted it to be <code class="docutils literal notranslate"><span class="pre">[-1,</span> <span class="pre">1]</span></code>, you would write <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Rescaling(1./127.5,</span> <span class="pre">offset=-1)</span></code>.</p></li>
</ul>
<ul class="simple">
<li><p>You can visualize the result of applying these layers to an image.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">resize_and_rescale</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_20_0.png" src="../_images/image_augmentation_20_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Verify that the pixels are in the <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code> range:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min and max pixel values:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">result</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Min and max pixel values: 0.0 1.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Data augmentation<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>You can use the Keras preprocessing layers for data augmentation as well, such as</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomFlip</span></code> and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomRotation</span></code>.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>Let’s create a few preprocessing layers and apply them repeatedly to the same image.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_augmentation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal_and_vertical&quot;</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the image to a batch.</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
  <span class="n">augmented_image</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../_images/image_augmentation_28_1.png" src="../_images/image_augmentation_28_1.png" />
</div>
</div>
<ul class="simple">
<li><p>There are a variety of preprocessing layers you can use for data augmentation including</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomContrast</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomCrop</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.keras.layers.RandomZoom</span></code>,</p></li>
</ul>
</li>
</ul>
<p>and others.</p>
</section>
<section id="two-options-to-use-the-keras-preprocessing-layers">
<h3>Two options to use the Keras preprocessing layers<a class="headerlink" href="#two-options-to-use-the-keras-preprocessing-layers" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>There are two ways you can use these preprocessing layers, with important trade-offs.</p></li>
</ul>
<section id="option-1-make-the-preprocessing-layers-part-of-your-model">
<h4>Option 1: Make the preprocessing layers part of your model<a class="headerlink" href="#option-1-make-the-preprocessing-layers-part-of-your-model" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="c1"># Add the preprocessing layers you created earlier.</span>
  <span class="n">resize_and_rescale</span><span class="p">,</span>
  <span class="n">data_augmentation</span><span class="p">,</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(),</span>
  <span class="c1"># Rest of your model.</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>There are two important points to be aware of in this case:</p>
<ul class="simple">
<li><p>Data augmentation will run on-device, synchronously with the rest of your layers, and benefit from GPU acceleration.</p></li>
<li><p>When you export your model using <code class="docutils literal notranslate"><span class="pre">model.save</span></code>, the preprocessing layers will be saved along with the rest of your model. If you later deploy this model, it will automatically standardize images (according to the configuration of your layers). This can save you from the effort of having to reimplement that logic server-side.</p></li>
</ul>
<ul class="simple">
<li><p>Note: Data augmentation is inactive at test time so input images will only be augmented during calls to <code class="docutils literal notranslate"><span class="pre">Model.fit</span></code> (not <code class="docutils literal notranslate"><span class="pre">Model.evaluate</span></code> or <code class="docutils literal notranslate"><span class="pre">Model.predict</span></code>).</p></li>
</ul>
</section>
<section id="option-2-apply-the-preprocessing-layers-to-your-dataset">
<h4>Option 2: Apply the preprocessing layers to your dataset<a class="headerlink" href="#option-2-apply-the-preprocessing-layers-to-your-dataset" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aug_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With this approach, you use <code class="docutils literal notranslate"><span class="pre">Dataset.map</span></code> to create a dataset that yields batches of augmented images. In this case:</p>
<ul class="simple">
<li><p>Data augmentation will happen asynchronously on the CPU, and is non-blocking. You can overlap the training of your model on the GPU with data preprocessing, using <code class="docutils literal notranslate"><span class="pre">Dataset.prefetch</span></code>, shown below.</p></li>
<li><p>In this case the preprocessing layers will not be exported with the model when you call <code class="docutils literal notranslate"><span class="pre">Model.save</span></code>. You will need to attach them to your model before saving it or reimplement them server-side. After training, you can attach the preprocessing layers before export.</p></li>
</ul>
<ul class="simple">
<li><p>You can find an example of the first option in this <a class="reference internal" href="image_classification_from_scratch.html"><span class="doc std std-doc">Image classification</span></a> tutorial.</p></li>
<li><p>Let’s demonstrate the second option here.</p></li>
</ul>
</section>
</section>
<section id="apply-the-preprocessing-layers-to-the-datasets">
<h3>Apply the preprocessing layers to the datasets<a class="headerlink" href="#apply-the-preprocessing-layers-to-the-datasets" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Configure the training, validation, and test datasets with the Keras preprocessing layers you created earlier.</p></li>
<li><p>You will also configure the datasets for performance, using parallel reads and buffered prefetching to yield batches from disk without I/O become blocking.</p></li>
<li><p>Learn more about dataset performance in the <a class="reference external" href="https://www.tensorflow.org/guide/data_performance">Better performance with the tf.data API</a> guide.</p></li>
</ul>
<p>Note: Data augmentation should only be applied to the training set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">AUTOTUNE</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span>

<span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="c1"># Resize and rescale all datasets.</span>
  <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> 
              <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

  <span class="c1"># Batch all datasets.</span>
  <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

  <span class="c1"># Use data augmentation only on the training set.</span>
  <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">data_augmentation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> 
                <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>

  <span class="c1"># Use buffered prefetching on all datasets.</span>
  <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">prepare</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_ds</span> <span class="o">=</span> <span class="n">prepare</span><span class="p">(</span><span class="n">val_ds</span><span class="p">)</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">prepare</span><span class="p">(</span><span class="n">test_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-a-model">
<h3>Train a model<a class="headerlink" href="#train-a-model" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>For completeness, you will now train a sequential model using the datasets you have just prepared.</p></li>
<li><p>The <a class="reference external" href="https://www.tensorflow.org/guide/keras/sequential_model">Sequential</a> model consists of three convolution blocks (<code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Conv2D</span></code>) with a max pooling layer (<code class="docutils literal notranslate"><span class="pre">tf.keras.layers.MaxPooling2D</span></code>) in each of them.</p></li>
<li><p>There’s a fully-connected layer (<code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Dense</span></code>) with 128 units on top of it that is activated by a ReLU activation function (<code class="docutils literal notranslate"><span class="pre">'relu'</span></code>).</p></li>
<li><p>This model has not been tuned for accuracy (the goal is to show you the mechanics).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  
  <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(),</span>
  
  <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(),</span>
  
  <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(),</span>
  
    
  <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Choose the <code class="docutils literal notranslate"><span class="pre">tf.keras.optimizers.Adam</span></code> optimizer and <code class="docutils literal notranslate"><span class="pre">tf.keras.losses.SparseCategoricalCrossentropy</span></code> loss function.</p></li>
<li><p>To view training and validation accuracy for each training epoch, pass the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> argument to <code class="docutils literal notranslate"><span class="pre">Model.compile</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Train for a few epochs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span><span class="o">=</span><span class="mi">5</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
  <span class="n">train_ds</span><span class="p">,</span>
  <span class="n">validation_data</span><span class="o">=</span><span class="n">val_ds</span><span class="p">,</span>
  <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/5
92/92 [==============================] - 22s 223ms/step - loss: 1.4549 - accuracy: 0.3767 - val_loss: 1.1546 - val_accuracy: 0.5559
Epoch 2/5
92/92 [==============================] - 20s 216ms/step - loss: 1.1224 - accuracy: 0.5433 - val_loss: 1.0648 - val_accuracy: 0.6049
Epoch 3/5
92/92 [==============================] - 20s 216ms/step - loss: 1.0072 - accuracy: 0.5858 - val_loss: 1.0126 - val_accuracy: 0.6158
Epoch 4/5
92/92 [==============================] - 20s 218ms/step - loss: 0.9506 - accuracy: 0.6223 - val_loss: 0.9392 - val_accuracy: 0.6376
Epoch 5/5
92/92 [==============================] - 20s 217ms/step - loss: 0.8954 - accuracy: 0.6468 - val_loss: 1.0059 - val_accuracy: 0.5477
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12/12 [==============================] - 1s 60ms/step - loss: 0.9189 - accuracy: 0.6076
Accuracy 0.6076294183731079
</pre></div>
</div>
</div>
</div>
</section>
<section id="custom-data-augmentation">
<h3>Custom data augmentation<a class="headerlink" href="#custom-data-augmentation" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>You can also create custom data augmentation layers.</p></li>
<li><p>This section of the tutorial shows two ways of doing so:</p></li>
<li><p>First, you will create a <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Lambda</span></code> layer. This is a good way to write concise code.</p></li>
<li><p>Next, you will write a new layer via <a class="reference external" href="https://www.tensorflow.org/guide/keras/custom_layers_and_models">subclassing</a>, which gives you more control.</p></li>
</ul>
<p>Both layers will randomly invert the colors in an image, according to some probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_invert_img</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
  <span class="k">if</span>  <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([])</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">x</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_invert</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">random_invert_img</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="p">))</span>

<span class="n">random_invert</span> <span class="o">=</span> <span class="n">random_invert</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
  <span class="n">augmented_image</span> <span class="o">=</span> <span class="n">random_invert</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_55_0.png" src="../_images/image_augmentation_55_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Next, implement a custom layer by <a class="reference external" href="https://www.tensorflow.org/guide/keras/custom_layers_and_models">subclassing</a>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RandomInvert</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random_invert_img</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">RandomInvert</span><span class="p">()(</span><span class="n">image</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../_images/image_augmentation_58_1.png" src="../_images/image_augmentation_58_1.png" />
</div>
</div>
<ul class="simple">
<li><p>Both of these layers can be used as described in options 1 and 2 above.</p></li>
</ul>
</section>
</section>
<section id="using-tf-image">
<h2>Using tf.image<a class="headerlink" href="#using-tf-image" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>The above Keras preprocessing utilities are convenient.</p></li>
<li><p>But, for finer control, you can write your own data augmentation pipelines or layers using <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> and <code class="docutils literal notranslate"><span class="pre">tf.image</span></code>.</p></li>
<li><p>You may also want to check out <a class="reference external" href="https://www.tensorflow.org/addons/tutorials/image_ops">TensorFlow Addons Image: Operations</a> and <a class="reference external" href="https://www.tensorflow.org/io/tutorials/colorspace">TensorFlow I/O: Color Space Conversions</a>.</p></li>
</ul>
<ul class="simple">
<li><p>Since the flowers dataset was previously configured with data augmentation, let’s reimport it to start fresh:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">),</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s1">&#39;tf_flowers&#39;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:80%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[80%:90%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span>
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Retrieve an image to work with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">get_label_name</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-05-08 20:14:01.258148: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/image_augmentation_65_1.png" src="../_images/image_augmentation_65_1.png" />
</div>
</div>
<ul class="simple">
<li><p>Let’s use the following function to visualize and compare the original and augmented images side-by-side:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">augmented</span><span class="p">):</span>
  <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original image&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Augmented image&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h3>Data augmentation<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<section id="flip-an-image">
<h4>Flip an image<a class="headerlink" href="#flip-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Flip an image either vertically or horizontally with <code class="docutils literal notranslate"><span class="pre">tf.image.flip_left_right</span></code>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flipped</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">flip_left_right</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">flipped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_70_0.png" src="../_images/image_augmentation_70_0.png" />
</div>
</div>
</section>
<section id="grayscale-an-image">
<h4>Grayscale an image<a class="headerlink" href="#grayscale-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>You can grayscale an image with <code class="docutils literal notranslate"><span class="pre">tf.image.rgb_to_grayscale</span></code>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grayscaled</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rgb_to_grayscale</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">grayscaled</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_72_0.png" src="../_images/image_augmentation_72_0.png" />
</div>
</div>
</section>
<section id="saturate-an-image">
<h4>Saturate an image<a class="headerlink" href="#saturate-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Saturate an image with <code class="docutils literal notranslate"><span class="pre">tf.image.adjust_saturation</span></code> by providing a saturation factor:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">saturated</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">adjust_saturation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">saturated</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_74_0.png" src="../_images/image_augmentation_74_0.png" />
</div>
</div>
</section>
<section id="change-image-brightness">
<h4>Change image brightness<a class="headerlink" href="#change-image-brightness" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Change the brightness of image with <code class="docutils literal notranslate"><span class="pre">tf.image.adjust_brightness</span></code> by providing a brightness factor:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bright</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">adjust_brightness</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bright</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_76_0.png" src="../_images/image_augmentation_76_0.png" />
</div>
</div>
</section>
<section id="center-crop-an-image">
<h4>Center crop an image<a class="headerlink" href="#center-crop-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Crop the image from center up to the image part you desire using <code class="docutils literal notranslate"><span class="pre">tf.image.central_crop</span></code>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cropped</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">central_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">central_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cropped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_78_0.png" src="../_images/image_augmentation_78_0.png" />
</div>
</div>
</section>
<section id="rotate-an-image">
<h4>Rotate an image<a class="headerlink" href="#rotate-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Rotate an image by 90 degrees with <code class="docutils literal notranslate"><span class="pre">tf.image.rot90</span></code>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rotated</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rotated</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_80_0.png" src="../_images/image_augmentation_80_0.png" />
</div>
</div>
</section>
</section>
<section id="random-transformations">
<h3>Random transformations<a class="headerlink" href="#random-transformations" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Warning: There are two sets of random image operations: <code class="docutils literal notranslate"><span class="pre">tf.image.random*</span></code> and <code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random*</span></code>. Using <code class="docutils literal notranslate"><span class="pre">tf.image.random*</span></code> operations is strongly discouraged as they use the old RNGs from TF 1.x. Instead, please use the random image operations introduced in this tutorial. For more information, refer to <span class="xref myst">Random number generation</span>.</p></li>
<li><p>Applying random transformations to the images can further help generalize and expand the dataset.</p></li>
</ul>
<ul class="simple">
<li><p>The current <code class="docutils literal notranslate"><span class="pre">tf.image</span></code> API provides eight such random image operations (ops):</p></li>
</ul>
<ul class="simple">
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_brightness"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_brightness</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_contrast"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_contrast</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_crop"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_crop</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_flip_left_right"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_flip_left_right</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_flip_up_down"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_flip_up_down</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_hue"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_hue</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_jpeg_quality"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_jpeg_quality</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/image/stateless_random_saturation"><code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_saturation</span></code></a></p></li>
</ul>
<ul class="simple">
<li><p>These random image ops are purely functional: the output only depends on the input.</p></li>
<li><p>This makes them simple to use in high performance, deterministic input pipelines.</p></li>
<li><p>They require a <code class="docutils literal notranslate"><span class="pre">seed</span></code> value be input each step. Given the same <code class="docutils literal notranslate"><span class="pre">seed</span></code>, they return the same results independent of how many times they are called.</p></li>
</ul>
<p>Note: <code class="docutils literal notranslate"><span class="pre">seed</span></code> is a <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> of shape <code class="docutils literal notranslate"><span class="pre">(2,)</span></code>  whose values are any integers.</p>
<p>In the following sections, you will:</p>
<ol class="simple">
<li><p>Go over examples of using random image operations to transform an image.</p></li>
<li><p>Demonstrate how to apply random transformations to a training dataset.</p></li>
</ol>
<section id="randomly-change-image-brightness">
<h4>Randomly change image brightness<a class="headerlink" href="#randomly-change-image-brightness" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Randomly change the brightness of <code class="docutils literal notranslate"><span class="pre">image</span></code> using <code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_brightness</span></code> by providing a brightness factor and <code class="docutils literal notranslate"><span class="pre">seed</span></code>. The brightness factor is chosen randomly in the range <code class="docutils literal notranslate"><span class="pre">[-max_delta,</span> <span class="pre">max_delta)</span></code> and is associated with the given <code class="docutils literal notranslate"><span class="pre">seed</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># tuple of size (2,)</span>
  <span class="n">stateless_random_brightness</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stateless_random_brightness</span><span class="p">(</span>
      <span class="n">image</span><span class="p">,</span> <span class="n">max_delta</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stateless_random_brightness</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_87_0.png" src="../_images/image_augmentation_87_0.png" />
<img alt="../_images/image_augmentation_87_1.png" src="../_images/image_augmentation_87_1.png" />
<img alt="../_images/image_augmentation_87_2.png" src="../_images/image_augmentation_87_2.png" />
</div>
</div>
</section>
<section id="randomly-change-image-contrast">
<h4>Randomly change image contrast<a class="headerlink" href="#randomly-change-image-contrast" title="Permalink to this headline">#</a></h4>
<p>-Randomly change the contrast of <code class="docutils literal notranslate"><span class="pre">image</span></code> using <code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_contrast</span></code> by providing a contrast range and <code class="docutils literal notranslate"><span class="pre">seed</span></code>. The contrast range is chosen randomly in the interval <code class="docutils literal notranslate"><span class="pre">[lower,</span> <span class="pre">upper]</span></code> and is associated with the given <code class="docutils literal notranslate"><span class="pre">seed</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># tuple of size (2,)</span>
  <span class="n">stateless_random_contrast</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stateless_random_contrast</span><span class="p">(</span>
      <span class="n">image</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stateless_random_contrast</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_90_0.png" src="../_images/image_augmentation_90_0.png" />
<img alt="../_images/image_augmentation_90_1.png" src="../_images/image_augmentation_90_1.png" />
<img alt="../_images/image_augmentation_90_2.png" src="../_images/image_augmentation_90_2.png" />
</div>
</div>
</section>
<section id="randomly-crop-an-image">
<h4>Randomly crop an image<a class="headerlink" href="#randomly-crop-an-image" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Randomly crop <code class="docutils literal notranslate"><span class="pre">image</span></code> using <code class="docutils literal notranslate"><span class="pre">tf.image.stateless_random_crop</span></code> by providing target <code class="docutils literal notranslate"><span class="pre">size</span></code> and <code class="docutils literal notranslate"><span class="pre">seed</span></code>. The portion that gets cropped out of <code class="docutils literal notranslate"><span class="pre">image</span></code> is at a randomly chosen offset and is associated with the given <code class="docutils literal notranslate"><span class="pre">seed</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># tuple of size (2,)</span>
  <span class="n">stateless_random_crop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stateless_random_crop</span><span class="p">(</span>
      <span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">210</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stateless_random_crop</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/image_augmentation_93_0.png" src="../_images/image_augmentation_93_0.png" />
<img alt="../_images/image_augmentation_93_1.png" src="../_images/image_augmentation_93_1.png" />
<img alt="../_images/image_augmentation_93_2.png" src="../_images/image_augmentation_93_2.png" />
</div>
</div>
</section>
</section>
<section id="apply-augmentation-to-a-dataset">
<h3>Apply augmentation to a dataset<a class="headerlink" href="#apply-augmentation-to-a-dataset" title="Permalink to this headline">#</a></h3>
<p>Let’s first download the image dataset again in case they are modified in the previous sections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">train_datasets</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">),</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s1">&#39;tf_flowers&#39;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:80%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[80%:90%]&#39;</span><span class="p">,</span> <span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span>
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next, define a utility function for resizing and rescaling the images. This function will be used in unifying the size and scale of images in the dataset:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resize_and_rescale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">])</span>
  <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s also define the <code class="docutils literal notranslate"><span class="pre">augment</span></code> function that can apply the random transformations to the images. This function will be used on the dataset in the next step.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">augment</span><span class="p">(</span><span class="n">image_label</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
  <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">image_label</span>
  <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">resize_and_rescale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_with_crop_or_pad</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">IMG_SIZE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">IMG_SIZE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
  <span class="c1"># Make a new seed.</span>
  <span class="n">new_seed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">stateless_split</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
  <span class="c1"># Random crop back to the original size.</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stateless_random_crop</span><span class="p">(</span>
      <span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="c1"># Random brightness.</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stateless_random_brightness</span><span class="p">(</span>
      <span class="n">image</span><span class="p">,</span> <span class="n">max_delta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<section id="option-1-using-tf-data-experimental-counter">
<h4>Option 1: Using tf.data.experimental.Counter<a class="headerlink" href="#option-1-using-tf-data-experimental-counter" title="Permalink to this headline">#</a></h4>
<p>Create a <code class="docutils literal notranslate"><span class="pre">tf.data.experimental.Counter</span></code> object (let’s call it <code class="docutils literal notranslate"><span class="pre">counter</span></code>) and <code class="docutils literal notranslate"><span class="pre">Dataset.zip</span></code> the dataset with <code class="docutils literal notranslate"><span class="pre">(counter,</span> <span class="pre">counter)</span></code>. This will ensure that each image in the dataset gets associated with a unique value (of shape <code class="docutils literal notranslate"><span class="pre">(2,)</span></code>) based on <code class="docutils literal notranslate"><span class="pre">counter</span></code> which later can get passed into the <code class="docutils literal notranslate"><span class="pre">augment</span></code> function as the <code class="docutils literal notranslate"><span class="pre">seed</span></code> value for random transformations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a `Counter` object and `Dataset.zip` it together with the training set.</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">train_datasets</span><span class="p">,</span> <span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">counter</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Map the <code class="docutils literal notranslate"><span class="pre">augment</span></code> function to the training dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">train_ds</span>
    <span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">augment</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">val_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">val_ds</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">test_ds</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="option-2-using-tf-random-generator">
<h4>Option 2: Using tf.random.Generator<a class="headerlink" href="#option-2-using-tf-random-generator" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">tf.random.Generator</span></code> object with an initial <code class="docutils literal notranslate"><span class="pre">seed</span></code> value. Calling the <code class="docutils literal notranslate"><span class="pre">make_seeds</span></code> function on the same generator object always returns a new, unique <code class="docutils literal notranslate"><span class="pre">seed</span></code> value.</p></li>
<li><p>Define a wrapper function that: 1) calls the <code class="docutils literal notranslate"><span class="pre">make_seeds</span></code> function; and 2) passes the newly generated <code class="docutils literal notranslate"><span class="pre">seed</span></code> value into the <code class="docutils literal notranslate"><span class="pre">augment</span></code> function for random transformations.</p></li>
</ul>
<p>Note: <code class="docutils literal notranslate"><span class="pre">tf.random.Generator</span></code> objects store RNG state in a <code class="docutils literal notranslate"><span class="pre">tf.Variable</span></code>, which means it can be saved as a <span class="xref myst">checkpoint</span> or in a <span class="xref myst">SavedModel</span>. For more details, please refer to <span class="xref myst">Random number generation</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a generator.</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;philox&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a wrapper function for updating seeds.</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">seed</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">make_seeds</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">augment</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">seed</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<p>Map the wrapper function <code class="docutils literal notranslate"><span class="pre">f</span></code> to the training dataset, and the <code class="docutils literal notranslate"><span class="pre">resize_and_rescale</span></code> function—to the validation and test sets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">train_datasets</span>
    <span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">val_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">val_ds</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_ds</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">test_ds</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">resize_and_rescale</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These datasets can now be used to train a model as shown previously.</p>
</section>
</section>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">#</a></h2>
<p>This tutorial demonstrated data augmentation using Keras preprocessing layers and <code class="docutils literal notranslate"><span class="pre">tf.image</span></code>.</p>
<ul class="simple">
<li><p>To learn how to include preprocessing layers inside your model, refer to the <span class="xref myst">Image classification</span> tutorial.</p></li>
<li><p>You may also be interested in learning how preprocessing layers can help you classify text, as shown in the <span class="xref myst">Basic text classification</span> tutorial.</p></li>
<li><p>You can learn more about <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> in this <span class="xref myst">guide</span>, and you can learn how to configure your input pipelines for performance <span class="xref myst">here</span>.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="image_classification_from_scratch.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Image preprocessing and data augmentation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="structured_data_classification_intro.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Classification I</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Jan Kirenz<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>